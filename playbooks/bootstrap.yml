---
- name: Bootstrap complete Minikube Homelab
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    kube_context: minikube
  tasks:

    - name: Ensure Minikube is running
      shell: |
        minikube status | grep "host: Running" || minikube start --driver=docker
      changed_when: false

    - name: Enable Minikube Ingress addon
      shell: minikube addons enable ingress
      changed_when: false

    - name: Deploy NGINX Ingress Controller via Helm
      shell: bash clusters/minikube/ingress/install-ingress.sh
      changed_when: false

    - name: Install cert-manager CRDs
      shell: kubectl apply -f https://github.com/cert-manager/cert-manager/releases/latest/download/cert-manager.crds.yaml
      changed_when: false

    - name: Install cert-manager Helm chart
      shell: |
        helm repo add jetstack https://charts.jetstack.io || true
        helm repo update
        helm upgrade --install cert-manager jetstack/cert-manager -n cert-manager --create-namespace --set installCRDs=true
      changed_when: false

    - name: Apply staging ClusterIssuer
      shell: kubectl apply -f clusters/minikube/cert-manager/cluster-issuer-staging.yaml
      changed_when: false

    - name: Apply production ClusterIssuer
      shell: kubectl apply -f clusters/minikube/cert-manager/cluster-issuer-prod.yaml
      changed_when: false

    - name: Install ArgoCD via Helm
      shell: |
        helm repo add argo https://argoproj.github.io/argo-helm || true
        helm repo update
        helm upgrade --install argocd argo/argo-cd -n argocd --create-namespace
      changed_when: false

    - name: Deploy Root ArgoCD App-of-Apps
      shell: kubectl apply -f clusters/minikube/apps/root-application.yaml -n argocd
      changed_when: false

    - name: Update /etc/hosts for Minikube domains
      become: yes
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
        state: present
      loop:
        - "{{ lookup('pipe','minikube ip') }} argocd.minikube.local homepage.minikube.local grafana.minikube.local prometheus.minikube.local alertmanager.minikube.local dashboard.minikube.local"

    - name: Wait for all pods in default namespace to be running
      shell: kubectl wait --for=condition=Ready pods --all --namespace default --timeout=300s
      changed_when: false
